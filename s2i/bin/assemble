#!/bin/bash

echo "---> Installing Thermostat Web Client source ..."
mv /tmp/src/* ./
mv /tmp/src/.{babelrc,eslintignore,eslintrc.yaml,eslintrc.test.yaml,htmlhintrc} ./

# "development" environment is intended to mean "on a developer's machine",
# and we use "testing" environment for ex. continuous deployment
if [ -z "${NODE_ENV}" ]; then
    export NODE_ENV=testing
fi

if [ -z "${NPM_CMD}" ]; then
    NPM_CMD="/opt/rh/rh-nodejs6/root/usr/bin/npm"
fi

echo "NODE_ENV=${NODE_ENV}"
echo "GATEWAY_URL=${GATEWAY_URL}"

if [ -z "${GATEWAY_URL}" ]; then
    echo "GATEWAY_URL must be set"
    exit 1
fi

echo "---> Building Thermostat Web Client ..."
NODE_ENV=development ${NPM_CMD} install
if [ $? -ne 0 ]; then
    echo "npm install failed" >&2
    exit 1
fi
${NPM_CMD} run build
if [ $? -ne 0 ]; then
    echo "npm run build failed" >&2
    exit 1
fi
${NPM_CMD} prune --production
if [ $? -ne 0 ]; then
    echo "npm prune failed" >&2
    exit 1
fi

web_client_dir="${THERMOSTAT_GATEWAY_HOME}/web-client"
echo "---> Installing Thermostat Web Client in "${web_client_dir}" ..."
mkdir -p "${web_client_dir}"
cp -r dist/* "${web_client_dir}"
if [ $? -ne 0 ]; then
    echo "Failed to install web client" >&2
    exit 1
fi

echo "---> Cleaning up sources ..."
rm -rf ./*

fix-permissions "${THERMOSTAT_GATEWAY_HOME}"
exit 0
